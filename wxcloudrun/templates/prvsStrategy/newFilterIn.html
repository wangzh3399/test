{% extends "prvsBase/Menubase.html" %}
{% block panel %}
{%load static%}
    <div class="page-hd">
        <h1 class="page-hd-title">
            新建初筛指标
        </h1>
        <p class="page-hd-desc">当前策略：xxxxx</p>
    </div>
    <div class="page-bd-15">
        <div class="page-bd" name="group" style="display: none;">
            <div class="weui-cells__title" name="grouptitle">条件组1：<a href="javascript:void(0)" name="nameSetBtn">名称设置</a>&nbsp&nbsp<a href="javascript:void(0)" name="groupDelBtn">删除</a></div>
            <ul class="collapse">
                <li class="js-show">
                    <div class="weui-flex js-category" id="js-category">
                        <div class="weui-flex__item" name="indicatorTitle">加减速指标(A/C),MACD...</div>
                        <i class="icon icon-35" name="icon"></i>
                    </div>
                    <div class="page-category js-categoryInner">
                        <div class="weui-cell weui-cell_swiped indicatorSelectCell" name="indicatorSelectCell">
                            <div class="weui-cell__bd" style="transform: translate3d(0px, 0px, 0px);">
                                <div class="weui-cell">
                                    <div class="weui-cell__bd" name="select">
                                        <p name="indicatorName">选择指标</p>
                                    </div>
                                    <div class="weui-cell__ft"><a name="indicatorDelBtn">删除</a></div>
                                </div>
                            </div>
                        </div>
                        <div class="weui-cell" style="padding: 0px 0px;">
                            <div class="weui-cell__bd" style="transform: translate3d(0px, 0px, 0px);">
                                <div class="weui-cell">
                                    <div class="weui-cell__bd">
                                        <div  class="weui-btn weui-btn_mini  bg-blue newIndicatorBtn" name="newIndicatorBtn">新增指标</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <a href="javascript:void(0);" class="weui-btn weui-btn_mini bg-blue newGroupBtn" name="newGroupBtn">新增条件组</a>           
    </div>
<script type="text/javascript">
    //变量定义
    indicatorsId = []; 
    stocksId = ["stockSelect"];
    var indicators = {{ indicators|safe }};
    groupIndex = [] //必须从小到大排列
    //绑定折叠
    function bindCollapse(){
        var Collapses = $("div[name^='indicatorTitle']");
        $(Collapses).unbind('click').click(function(){
            if($(this).parent().parent().hasClass("js-show")){
                $(this).parent().parent().removeClass('js-show');
                $(this).next().removeClass('icon-35').addClass('icon-74');
            }
            else{
                $(this).parent().parent().addClass("js-show")
                $(this).next().removeClass('icon-74').addClass('icon-35');
            }
        });
    }
    function bindNewGroupBtn(){//这个用选择器通配、元素链实现会简单很多。
        $(".newGroupBtn").unbind("click").click(function(){
            var pageBd = $(".page-bd:first").clone();
            console.log(pageBd);
            $(this).before(pageBd);
            $(".page-bd:last").attr("style","");
            rearrange();
            reBindAll();
        });
    }
    function bindNewIndicatorBtn(){
        var newIndicatorBtns = $("div[name^='newIndicatorBtn']");
        $(newIndicatorBtns).unbind("click").click(function(){
            var selectCell = $(".indicatorSelectCell:first").clone();
            $(this).parent().parent().parent().parent().before(selectCell);
            rearrange();
            reBindAll()
        });
    }
    function bindPicker(){
        var indicatorSelects = $("div[name^='select']");
        $(indicatorSelects).unbind("click").click(function(e){
            weui.picker(indicators, {
                depth: 2,
                defaultValue: [0, 0],
                onChange: function (result) {
                    //console.log(result);
                },
                onConfirm: function (result) {
                    $(e.target).html("指标:"+result[1]["label"]);
                    //e.srcElement.html("指标:"+result[1]["label"])
                    //console.log(indicatorIndex);
                },
                id: 'cascadePicker'
            });
        });
    };
    function bindNameSetBtn(){ 
        $("a[name^='nameSetBtn']").unbind('click').click(function(e) {
                $.prompts({
                    title: "设置"+$(e.target).parent().html().split("：")[0]+"的名称",
                    //text: '内容文案',
                    input: $(e.target).html()=="名称设置"?"":$(e.target).html(),
                    empty: false, // 是否允许为空
                    onOK: function (input) {
                        $(e.target).html(input);
                    },
                    onCancel: function () {
                        //点击取消
                    }
                });
            })
    }
    function bindGroupDelBtn(){ 
        $("a[name^='groupDelBtn']").unbind('click').click(function(e) {
            $.confirm("确认删除["+$(e.target).parent().html().split("：")[0]+"]吗?", "确认删除?", function() {
                $(e.target).parent().parent().remove();
                rearrange();
                reBindAll();
            }, function() {
                    //取消操作
            });
        });
        
    }
    function bindIndicatorDelBtn(){ 
        $("a[name^='indicatorDelBtn']").unbind('click').click(function(e) {
            $.confirm("确认删除[]吗?", "确认删除?", function() {
                $(e.target).parent().parent().parent().remove();
                rearrange();
                reBindAll();
            }, function() {
                    //取消操作
            });
        });
        
    }
    function reBindAll(){
        bindCollapse();
        bindNewGroupBtn();
        bindNewIndicatorBtn();
        bindPicker();
        bindNameSetBtn();
        bindGroupDelBtn();
        bindIndicatorDelBtn()
    }
    function rearrange(){
        //重排组名
        var groups = $(".weui-cells__title");
        console.log(groups);
        for(i=0;i<groups.length;i++){
            console.log(i);
            preTxt = $(groups[i]).html();
            newTxt = preTxt.replace(/\d+：/i,i+"：")
            $(groups[i]).html(newTxt);
        }
    }
    $(document).ready(function(){ 
        var pageBd = $(".page-bd").clone();
        $(".newGroupBtn").before(pageBd);
        $(".page-bd:last").attr("style","");
        reBindAll();
    });  

</script>
</html>
{%load static%}
{% endblock %}